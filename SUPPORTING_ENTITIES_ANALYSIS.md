# Анализ вспомогательных сущностей системы Leasing Aggregator

## Обзор

Данный документ содержит подробный анализ вспомогательных сущностей системы Leasing Aggregator: User (Пользователь), Organization (Организация), Integration (Интеграция), Template (Шаблон) и Report (Отчет). Эти сущности обеспечивают функциональность управления пользователями, организационной структурой, внешними интеграциями, шаблонами документов и бизнес-аналитикой.

## 1. Сущность User (Пользователь)

### 1.1 Структура интерфейса User

```typescript
interface User {
  id: string;
  fullName: string;
  login: string;
  role: RoleId;
  version: UserVersion;
  attachments: UserAttachment[];
  createdAt: string;
  updatedAt: string;
}
```

### 1.2 Система ролей и доступа

Система поддерживает четыре основные роли пользователей:

- **BROKER** ('broker') - Брокер
  - Доступ к сделкам и клиентам
  - Базовый функционал работы с лизинговыми операциями

- **BROKER_MANAGER** ('broker-manager') - Руководитель брокера
  - Расширенный доступ включает отчеты и управление организацией
  - Контроль над деятельностью подчиненных брокеров

- **BUSINESS_ADMIN** ('business-admin') - Бизнес-администратор
  - Управление лизинговыми компаниями и брокерами
  - Настройка бизнес-процессов и продуктов
  - Доступ к аналитическим отчетам

- **TECH_ADMIN** ('tech-admin') - Технический администратор
  - Управление пользователями и интеграциями
  - Настройка шаблонов и системных параметров

### 1.3 Версионность пользователей

```typescript
interface UserVersion {
  id: string;
  number: number;
  status: 'draft' | 'active' | 'archived';
  startDate?: string;
  endDate?: string;
  previousVersionId?: string;
  nextVersionId?: string;
}
```

Пользователи поддерживают систему версионности с жизненным циклом: черновик → активная → архивная.

### 1.4 Управление вложениями

```typescript
interface UserAttachment {
  id: string;
  name: string;
  type: string;
  size: number;
  url: string;
  canPreview: boolean;
}
```

Поддерживаются различные типы документов: паспорта, трудовые договоры, фотографии с возможностью предварительного просмотра.

## 2. Сущность Organization (Организация)

### 2.1 Структура интерфейса Organization

```typescript
interface Organization {
  id: string;
  opf: string; // ОПФ (организационно-правовая форма)
  fullName: string;
  inn: string;
  version: EntityVersion;
  requisites: OrganizationRequisites;
  attachments: OrganizationAttachment[];
}
```

### 2.2 Реквизиты организации

```typescript
interface OrganizationRequisites {
  fullName: string; // Полное наименование
  inn: string; // ИНН
  kpp: string; // КПП
  ogrn: string; // ОГРН
  address: string; // Адрес
  phone: string; // Телефон
  email: string; // Email
  directorName: string; // ФИО директора
  foundationDate: string; // Дата основания
}
```

### 2.3 Управление сотрудниками

```typescript
interface Employee {
  id: string;
  fullName: string;
  login: string;
  role: EmployeeRole;
  status: EmployeeStatus;
  activeDealsCount: number;
  isCurrentUser?: boolean;
}
```

Роли сотрудников:
- 'Брокер'
- 'Руководитель брокера'
- 'Бизнес-администратор'
- 'Технический администратор'

Статусы сотрудников:
- 'Активен'
- 'Ожидает активации'

### 2.4 Документооборот организации

Организация поддерживает управление документами:
- Устав организации
- Свидетельство о регистрации
- Справки из налоговой
- Лицензии на деятельность
- Банковские реквизиты

## 3. Сущность Integration (Интеграция)

### 3.1 Структура интерфейса Integration

```typescript
interface Integration {
  id: number;
  name: string;
  isActive: boolean;
  lastRunDate: string | null;
  description: string;
  createdAt: string;
  updatedAt: string;
}
```

### 3.2 Типы интеграций

Система поддерживает интеграции с различными внешними сервисами:

- **Автоданные API v2.1** - получение информации об автомобилях по VIN-коду
- **ФНС ЕГРЮЛ/ЕГРИП** - данные об организациях по ИНН
- **Контур.Фокус API** - комбинированная интеграция для автомобилей и организаций
- **Сбербанк Бизнес Онлайн** - проверка банковских данных организаций
- **Dadata.ru API** - тестовая интеграция для разработки
- **ГИБДД Проверка ТС** - проверка транспортных средств
- **Росреестр API** - данные о недвижимости
- **1C:Предприятие 8.3** - синхронизация с системой 1C

### 3.3 Управление статусами интеграций

Каждая интеграция имеет:
- Статус активности (включена/выключена)
- Дату последнего запуска
- Описание функциональности
- Временные метки создания и обновления

## 4. Сущность Template (Шаблон)

### 4.1 Структура интерфейса Template

```typescript
interface Template {
  id: string;
  name: string;
  type: string; // Тип предмета лизинга
  keyIdentifier: string; // Ключевой идентификатор
  additionalAttributes: string; // Дополнительные атрибуты через ;
  version: EntityVersion;
  createdAt: string;
  updatedAt: string;
}
```

### 4.2 Коллекции шаблонов

```typescript
interface TemplateCollection {
  id: string;
  leasingCompanyId: string;
  leasingCompanyName: string;
  leasingObjectType: string; // Предмет лизинга
  templateNames: string; // Наименования шаблонов через ;
  version: EntityVersion;
  createdAt: string;
  updatedAt: string;
}
```

### 4.3 Типы предметов лизинга

Система поддерживает следующие категории:

**Транспорт:**
- Легковые автомобили
- Грузовые автомобили

**Авиация:**
- Воздушные суда

**Судоходство:**
- Морские суда

**Оборудование:**
- Строительная техника
- Медицинское оборудование
- IT-оборудование
- Промышленное оборудование

### 4.4 Примеры шаблонов

- **Шаблон VIN-кода** - для автомобилей с ключевым идентификатором VIN
- **Шаблон технических характеристик** - с атрибутами: мощность, крутящий момент, расход топлива, тип привода, марка, модель, год выпуска, цвет, объем двигателя
- **Шаблон регистрационного номера** - для воздушных судов
- **Шаблон IMO номера** - для морских судов

## 5. Сущность Report (Отчет)

### 5.1 Структура интерфейса Report

```typescript
interface Report {
  id: string;
  name: string;
  description: string;
  category: 'financial' | 'operational' | 'analytical';
  lastGenerated?: Date;
  parameters: ReportParameter[];
}
```

### 5.2 Параметры отчетов

```typescript
interface ReportParameter {
  key: string;
  label: string;
  type: 'date' | 'select' | 'text' | 'number';
  required: boolean;
  options?: string[];
  defaultValue?: any;
}
```

### 5.3 Категории отчетов

**Финансовые отчеты (financial):**
- Комиссионные доходы
- Портфель клиентов

**Операционные отчеты (operational):**
- Активность клиентов
- Отчет по лизинговым компаниям

**Аналитические отчеты (analytical):**
- Анализ сделок
- Ежемесячная эффективность

### 5.4 Примеры отчетов

1. **Комиссионные доходы**
   - Параметры: период, фильтр по клиентам
   - Данные: клиент, лизинговая компания, сумма сделки, ставка комиссии, статус выплаты

2. **Активность клиентов**
   - Параметры: период, тип активности, минимальное количество сделок
   - Данные: обращения, консультации, завершенные сделки, общий объем

3. **Анализ сделок**
   - Параметры: период, статус сделки, диапазон сумм
   - Данные: ID сделки, клиент, лизинговая компания, тип объекта, сумма, срок

4. **Отчет по лизинговым компаниям**
   - Параметры: период, фильтр по компаниям
   - Данные: количество сделок, общий объем, средний размер сделки, комиссии

## 6. Общие паттерны

### 6.1 Версионность

Все основные сущности (User, Organization, Template) используют единую систему версионности:
- Статусы: draft → active → archived
- Связи между версиями через previousVersionId/nextVersionId
- Временные рамки действия версий

### 6.2 Управление вложениями

Стандартизированный подход к работе с файлами:
- Уникальные идентификаторы
- Метаданные файлов (имя, тип, размер)
- Поддержка предварительного просмотра
- URL для доступа к файлам

### 6.3 CRUD операции

Все сущности поддерживают стандартные операции:
- Создание (Create)
- Чтение (Read)
- Обновление (Update)
- Удаление (Delete)

### 6.4 Временные метки

Стандартные поля для отслеживания изменений:
- createdAt - дата создания
- updatedAt - дата последнего обновления

## 7. Взаимосвязи между сущностями

### 7.1 User ↔ Organization
- Пользователи принадлежат организации
- Организация управляет сотрудниками
- Роли определяют доступ к функциональности

### 7.2 Template ↔ LeasingCompany
- Шаблоны привязаны к лизинговым компаниям
- Коллекции шаблонов группируют по типам предметов лизинга

### 7.3 Report ↔ User Role
- Доступ к отчетам зависит от роли пользователя
- Брокеры и руководители имеют доступ к отчетам
- Бизнес-администраторы имеют расширенный доступ

### 7.4 Integration ↔ System
- Интеграции обеспечивают связь с внешними системами
- Используются для автоматического заполнения данных
- Управляются техническими администраторами

## Заключение

Вспомогательные сущности образуют основу инфраструктуры системы Leasing Aggregator, обеспечивая:

1. **Управление пользователями** с ролевой моделью доступа
2. **Организационную структуру** с управлением сотрудниками
3. **Внешние интеграции** для автоматизации процессов
4. **Шаблонизацию** для стандартизации документооборота
5. **Бизнес-аналитику** через систему отчетов

Все сущности следуют единым паттернам версионности, управления вложениями и CRUD операций, что обеспечивает консистентность архитектуры системы.